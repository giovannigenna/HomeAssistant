blueprint:
  name: Clima Intelligente con Happy Hour
  description: Accende il condizionatore per caldo o freddo in base a soglie personalizzate e fascia oraria economica.
  domain: automation
  input:
    condizionatore:
      name: Climatizzatore
      selector:
        entity:
          domain: climate
    temperatura:
      name: Sensore temperatura
      selector:
        entity:
          domain: sensor
    umidita:
      name: Sensore umidit√†
      selector:
        entity:
          domain: sensor
    consumo:
      name: Sensore consumo
      selector:
        entity:
          domain: sensor
    persona:
      name: Persona da monitorare
      selector:
        entity:
          domain: person
    soglia_caldo:
      default: 21
      selector:
        number: {min: 10, max: 30, step: 0.5}
    soglia_freddo:
      default: 26
      selector:
        number: {min: 20, max: 35, step: 0.5}
    soglia_umidita:
      default: 60
      selector:
        number: {min: 0, max: 100}
    soglia_consumo:
      default: 2500
      selector:
        number: {min: 0, max: 10000}
    target_caldo:
      default: 21
      selector:
        number: {min: 10, max: 30}
    target_freddo:
      default: 23
      selector:
        number: {min: 15, max: 30}

trigger:
  - platform: time_pattern
    minutes: "/5"
  - platform: state
    entity_id: !input temperatura
  - platform: state
    entity_id: !input umidita
  - platform: state
    entity_id: !input persona

variables:
  current_temp: "{{ states(temperature) | float(0) }}"
  current_humidity: "{{ states(umidita) | float(0) }}"
  current_consumo: "{{ states(consumo) | float(0) }}"
  soglia_freddo_v: !input soglia_freddo
  soglia_umidita_v: !input soglia_umidita
  soglia_caldo_v: !input soglia_caldo
  soglia_consumo_v: !input soglia_consumo
  target_freddo_v: !input target_freddo
  target_caldo_v: !input target_caldo
  condizionatore_id: !input condizionatore

condition:
  - condition: state
    entity_id: !input persona
    state: "home"
  - condition: template
    value_template: "{{ current_consumo < soglia_consumo_v }}"

action:
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ current_temp > soglia_freddo_v and current_humidity > soglia_umidita_v }}
        sequence:
          - service: climate.set_temperature
            data:
              temperature: "{{ target_freddo_v }}"
              hvac_mode: cool
            target:
              entity_id: "{{ condizionatore_id }}"
      - conditions:
          - condition: template
            value_template: >
              {{ current_temp < soglia_caldo_v }}
        sequence:
          - service: climate.set_temperature
            data:
              temperature: "{{ target_caldo_v }}"
              hvac_mode: heat
            target:
              entity_id: "{{ condizionatore_id }}"
    default:
      - service: climate.turn_off
        target:
          entity_id: "{{ condizionatore_id }}"
